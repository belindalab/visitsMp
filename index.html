<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Визиты МП — просмотр</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #DF3B20 0%, #424B52 100%);
    min-height: 100vh;
    padding: 20px;
    line-height: 1.6;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    padding: 30px;
    animation: slideIn 0.6s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  h2 {
    color: #2d3748;
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 30px;
    text-align: center;
    background: linear-gradient(135deg, #DF3B20, #424B52);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 25px;
    align-items: flex-end;
  }

  label {
    font-size: 14px;
    color: #4a5568;
    font-weight: 600;
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
    min-width: 200px;
  }

  select, input {
    padding: 14px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 14px;
    transition: all 0.3s ease;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    touch-action: manipulation;
  }

  select {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23424B52' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
  }

  select:focus, input:focus {
    outline: none;
    border-color: #DF3B20;
    box-shadow: 0 0 0 3px rgba(223, 59, 32, 0.1);
    transform: translateY(-1px);
  }

  button {
    padding: 14px 24px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, #DF3B20, #424B52);
    color: white;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(223, 59, 32, 0.3);
    position: relative;
    overflow: hidden;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
  }

  button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(223, 59, 32, 0.4);
  }

  button:active:not(:disabled) {
    transform: translateY(0);
  }

  button:disabled, select:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  }

  .stats {
    display: flex;
    gap: 20px;
    margin: 30px 0;
    flex-wrap: wrap;
  }

  .stat {
    flex: 1;
    padding: 25px;
    background: linear-gradient(135deg, #f7fafc, #edf2f7);
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: fadeInUp 0.6s ease-out;
  }

  .stat:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }

  .stat b {
    display: block;
    font-size: 2.5rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #DF3B20, #424B52);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .stat div {
    color: #718096;
    font-size: 14px;
    font-weight: 500;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 30px;
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    animation: fadeInUp 0.6s ease-out;
  }

  th {
    background: linear-gradient(135deg, #f7fafc, #edf2f7);
    padding: 16px;
    text-align: left;
    font-weight: 600;
    color: #2d3748;
    border-bottom: 2px solid #e2e8f0;
  }

  td {
    padding: 16px;
    border-bottom: 1px solid #f1f5f9;
    color: #4a5568;
    transition: background-color 0.2s ease;
  }

  tr:hover td {
    background-color: #f8fafc;
  }

  .hint {
    font-size: 13px;
    color: #718096;
    align-self: flex-end;
    padding: 8px 12px;
    background: rgba(223, 59, 32, 0.1);
    border-radius: 8px;
    font-weight: 500;
  }

  /* Улучшенные анимации загрузки */
  .loader {
    display: none;
    justify-content: center;
    align-items: center;
    margin: 30px 0;
    flex-direction: column;
    gap: 20px;
  }

  .loader.show {
    display: flex;
    animation: fadeIn 0.3s ease-in;
  }

  .loading-container {
    position: relative;
    width: 80px;
    height: 80px;
  }

  .spinner {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: conic-gradient(from 0deg, transparent, #DF3B20, #424B52, transparent);
    animation: spin 1.5s linear infinite;
    position: relative;
  }

  .spinner::before {
    content: '';
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    bottom: 10px;
    background: white;
    border-radius: 50%;
  }

  .loading-text {
    color: #4a5568;
    font-size: 16px;
    font-weight: 500;
    animation: pulse 2s ease-in-out infinite;
  }

  .loading-dots {
    display: inline-block;
    animation: dots 1.5s ease-in-out infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  @keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
  }

  /* Анимация для статистики */
  .stat-animate {
    animation: countUp 1s ease-out;
  }

  @keyframes countUp {
    from {
      opacity: 0;
      transform: scale(0.5);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Анимация для таблицы */
  .table-row {
    animation: slideInRow 0.5s ease-out;
  }

  @keyframes slideInRow {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Разделители дат в таблице */
  .date-separator {
    background: linear-gradient(135deg, #DF3B20, #424B52);
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0 5px 0;
    box-shadow: 0 2px 8px rgba(223, 59, 32, 0.2);
  }

  /* График */
  .chart-container {
    margin-top: 30px;
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    animation: fadeInUp 0.6s ease-out;
  }

  .chart-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 20px;
    text-align: center;
    background: linear-gradient(135deg, #DF3B20, #424B52);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .chart {
    height: 300px;
    position: relative;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    background: linear-gradient(to top, rgba(223, 59, 32, 0.02), transparent);
  }

  .chart-svg {
    width: 100%;
    height: 100%;
  }

  .chart-line {
    fill: none;
    stroke: #DF3B20;
    stroke-width: 3;
    stroke-linecap: round;
    stroke-linejoin: round;
    filter: drop-shadow(0 2px 4px rgba(223, 59, 32, 0.3));
    stroke-dasharray: 1000;
    stroke-dashoffset: 1000;
    animation: drawLine 2s ease-out forwards;
  }

  @keyframes drawLine {
    to {
      stroke-dashoffset: 0;
    }
  }

  .chart-point {
    fill: #DF3B20;
    stroke: white;
    stroke-width: 2;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0;
    animation: fadeInPoint 0.5s ease-out forwards;
  }

  @keyframes fadeInPoint {
    from {
      opacity: 0;
      transform: scale(0);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .chart-point:hover {
    fill: #424B52;
    r: 8;
    filter: drop-shadow(0 4px 8px rgba(223, 59, 32, 0.4));
  }

  .chart-point.selected {
    fill: #424B52;
    r: 8;
  }

  .chart-grid {
    stroke: #e2e8f0;
    stroke-width: 1;
    opacity: 0.5;
  }

  .chart-grid-horizontal {
    stroke-dasharray: 2,2;
  }

  .point-label {
    position: absolute;
    background: rgba(66, 75, 82, 0.95);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 1000;
  }

  .point-label.show {
    opacity: 1;
  }

  .chart-trend {
    fill: none;
    stroke: #424B52;
    stroke-width: 2;
    stroke-dasharray: 5,5;
    opacity: 0.7;
  }

  .point-value {
    font-size: 12px;
    font-weight: 600;
    fill: #424B52;
    text-anchor: middle;
    dominant-baseline: middle;
    opacity: 0;
    animation: fadeInValue 0.5s ease-out forwards;
  }

  @keyframes fadeInValue {
    from {
      opacity: 0;
      transform: translateY(-5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }


  .chart-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 12px;
    color: #718096;
  }

  .chart-y-axis {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 40px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    font-size: 12px;
    color: #718096;
    padding: 20px 5px;
  }

  .chart-data {
    position: absolute;
    left: 50px;
    right: 20px;
    top: 20px;
    bottom: 40px;
    display: flex;
    align-items: flex-end;
    gap: 2px;
  }

  .bar-tooltip {
    position: absolute;
    background: rgba(66, 75, 82, 0.95);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 1000;
  }

  .bar-tooltip.show {
    opacity: 1;
  }

  /* Мобильные оптимизации */
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }

    .container {
      padding: 15px;
      margin: 0;
      border-radius: 15px;
    }

    h2 {
      font-size: 1.8rem;
      margin-bottom: 20px;
    }

    .row {
      flex-direction: column;
      gap: 12px;
    }

    label {
      min-width: auto;
      width: 100%;
    }

    select, input {
      min-width: auto;
      width: 100%;
      padding: 12px 14px;
      font-size: 16px; /* Предотвращает zoom на iOS */
    }

    button {
      width: 100%;
      padding: 16px 24px;
      font-size: 16px;
    }

    .hint {
      align-self: flex-start;
      margin-top: 5px;
    }

    .stats {
      flex-direction: column;
      gap: 12px;
      margin: 20px 0;
    }

    .stat {
      padding: 20px;
      text-align: center;
    }

    .stat b {
      font-size: 2.2rem;
    }

    .stat div {
      font-size: 13px;
    }

    /* Мобильная таблица */
    table {
      font-size: 14px;
      border-radius: 12px;
      overflow-x: auto;
      display: block;
      white-space: nowrap;
    }

    table, thead, tbody, th, td, tr {
      display: block;
    }

    thead tr {
      position: absolute;
      top: -9999px;
      left: -9999px;
    }

    tr {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 12px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    td {
      border: none;
      padding: 6px 0;
      position: relative;
      padding-left: 35%;
      white-space: normal;
    }

    td:before {
      content: attr(data-label) ": ";
      position: absolute;
      left: 6px;
      width: 30%;
      padding-right: 10px;
      white-space: nowrap;
      font-weight: 600;
      color: #424B52;
    }

    .date-separator {
      padding: 10px;
      font-size: 14px;
      margin: 8px 0;
    }

    /* Мобильный график */
    .chart-container {
      padding: 15px;
      margin-top: 20px;
    }

    .chart-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
    }

    .chart {
      height: 200px;
      padding: 10px;
    }

    .chart-svg {
      height: 100%;
    }

    .chart-line {
      stroke-width: 2.5;
    }

    .chart-point {
      r: 5;
    }

    .chart-point:hover,
    .chart-point.selected {
      r: 7;
    }

    .chart-grid {
      stroke-width: 0.5;
    }

    .chart-labels {
      font-size: 10px;
      margin-top: 8px;
    }

    .point-label {
      font-size: 11px;
      padding: 3px 6px;
    }


    /* Улучшенный лоадер для мобильных */
    .loading-container {
      width: 60px;
      height: 60px;
    }

    .spinner {
      width: 60px;
      height: 60px;
    }

    .loading-text {
      font-size: 14px;
    }
  }

  /* Очень маленькие экраны */
  @media (max-width: 480px) {
    .container {
      padding: 10px;
    }

    h2 {
      font-size: 1.5rem;
    }

    .stat {
      padding: 15px;
    }

    .stat b {
      font-size: 1.8rem;
    }

    .chart {
      height: 180px;
    }

    td:before {
      font-size: 12px;
    }
  }

  /* Горизонтальная ориентация на мобильных */
  @media (max-width: 768px) and (orientation: landscape) {
    .container {
      padding: 10px;
    }

    h2 {
      font-size: 1.5rem;
      margin-bottom: 15px;
    }

    .chart {
      height: 150px;
    }
  }
</style>
</head>
<body>
  <div class="container">
  <h2>Визиты медицинских представителей</h2>

  <div class="row">
    <label>Дата от
      <input type="date" id="from">
    </label>
    <label>Дата до
      <input type="date" id="to">
    </label>
      <div class="hint">Максимум 62 дня</div>
  </div>

  <div class="row">
    <label>Территория
      <select id="territory" disabled>
        <option value="">(сначала выберите даты)</option>
      </select>
    </label>
    <label>Мед представитель
      <select id="rep" disabled>
        <option value="">(после выбора территории)</option>
      </select>
    </label>
    <div style="align-self:flex-end">
        <button id="showBtn" disabled>
          <span>Показать</span>
        </button>
      </div>
    </div>

    <div class="loader" id="loader">
      <div class="loading-container">
        <div class="spinner"></div>
      </div>
      <div class="loading-text">
        Загрузка<span class="loading-dots"></span>
    </div>
  </div>

  <div class="stats" id="stats" style="display:none">
      <div class="stat">
        <b id="v1">0</b>
        <div>Количество визитов</div>
      </div>
      <div class="stat">
        <b id="v2">0</b>
        <div>Количество уникальных визитов (доктора)</div>
      </div>
      <div class="stat">
        <b id="v3">0</b>
        <div>Количество ЛПУ</div>
      </div>
  </div>

  <table id="table" style="display:none">
      <thead>
        <tr>
          <th>Дата визита</th>
          <th>Имя доктора</th>
          <th>Специальность</th>
          <th>ЛПУ</th>
        </tr>
      </thead>
    <tbody></tbody>
  </table>

    <div class="chart-container" id="chartContainer" style="display:none">
      <div class="chart-title">Количество визитов по дням</div>
      <div class="chart">
        <svg class="chart-svg" id="chartSvg">
          <defs>
            <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:#DF3B20;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#424B52;stop-opacity:1" />
            </linearGradient>
          </defs>
        </svg>
        <div class="chart-labels" id="chartLabels"></div>
      </div>
    </div>
  </div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbwWuHUvwa5q_JO4II2k7mc-OzIhyz5untrv2YgyA4E-aBPE9M8gJdjHd7aitEr2SatQHg/exec'; // вставьте URL веб-приложения

const fromEl = document.getElementById('from');
const toEl   = document.getElementById('to');
const terrEl = document.getElementById('territory');
const repEl  = document.getElementById('rep');
const btn    = document.getElementById('showBtn');
const loader = document.getElementById('loader');


function showLoader(message = 'Загрузка'){ 
  loader.querySelector('.loading-text').innerHTML = `${message}<span class="loading-dots"></span>`;
  loader.classList.add('show');
  loader.style.display = 'flex';
}
function hideLoader(){ 
  loader.classList.remove('show');
  setTimeout(() => {
    loader.style.display = 'none';
  }, 300);
}

// Функция сброса фильтров
function resetFilters() {
  terrEl.disabled = true;
  repEl.disabled = true;
  btn.disabled = true;
  terrEl.innerHTML = '<option value="">(сначала выберите даты)</option>';
  repEl.innerHTML = '<option value="">(после выбора территории)</option>';
  
  // Скрываем результаты
  document.getElementById('stats').style.display = 'none';
  document.getElementById('table').style.display = 'none';
  document.getElementById('chartContainer').style.display = 'none';
}


function daysBetween(a,b){
  const d1 = new Date(a+'T00:00:00'), d2 = new Date(b+'T00:00:00');
  return Math.ceil((d2-d1)/(1000*60*60*24))+1;
}

function datesValid(){
  const f = fromEl.value, t = toEl.value;
  if (!f || !t) return false;
  if (new Date(f) > new Date(t)) return false;
  if (daysBetween(f,t) > 62) return false;
  return true;
}

async function loadTerritories(){
  if (!datesValid()) {
    resetFilters();
    return;
  }
  terrEl.disabled = true; repEl.disabled = true; btn.disabled = true;
  showLoader('Загрузка территорий');
  try{
    const url = `${API}?act=meta&what=territories&from=${fromEl.value}&to=${toEl.value}`;
    const js  = await (await fetch(url)).json();
    terrEl.innerHTML = '<option value="">(все)</option>';
    (js.territories||[]).forEach(t=>{
      const o=document.createElement('option'); o.value=o.textContent=t; terrEl.appendChild(o);
    });
    terrEl.disabled=false;
  }catch(e){ alert('Ошибка загрузки территорий: '+e); }
  finally{ hideLoader(); }
}


async function loadReps(){
  repEl.disabled = true; btn.disabled = true;
  repEl.innerHTML = '<option value="">(все)</option>';
  if (!terrEl.value && !datesValid()) return;
  showLoader('Загрузка представителей');
  try{
    const url = `${API}?act=meta&what=reps&from=${fromEl.value}&to=${toEl.value}&territory=${encodeURIComponent(terrEl.value||'')}`;
    const js = await (await fetch(url)).json();
    (js.reps||[]).forEach(r=>{
      const o=document.createElement('option'); o.value=o.textContent=r; repEl.appendChild(o);
    });
    repEl.disabled = false;
    btn.disabled = false;
  }catch(e){ alert('Ошибка загрузки МП: '+e); }
  finally{ hideLoader(); }
}

// Функция анимации счетчика
function animateCounter(element, target, duration = 1000) {
  const start = 0;
  const increment = target / (duration / 16);
  let current = start;
  
  const timer = setInterval(() => {
    current += increment;
    if (current >= target) {
      element.textContent = target;
      clearInterval(timer);
    } else {
      element.textContent = Math.floor(current);
    }
  }, 16);
}

// Функция форматирования даты
function formatDate(dateStr) {
  const date = new Date(dateStr + 'T00:00:00');
  return date.toLocaleDateString('ru-RU', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
}

// Функция создания линейного графика
function createChart(visitsData) {
  const chartContainer = document.getElementById('chartContainer');
  const svg = document.getElementById('chartSvg');
  const chartLabels = document.getElementById('chartLabels');
  
  // Группируем визиты по датам
  const visitsByDate = {};
  visitsData.forEach(visit => {
    const date = visit.date;
    visitsByDate[date] = (visitsByDate[date] || 0) + 1;
  });
  
  // Сортируем даты
  const sortedDates = Object.keys(visitsByDate).sort();
  const maxVisits = Math.max(...Object.values(visitsByDate));
  
  // Очищаем SVG
  svg.innerHTML = `
    <defs>
      <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#DF3B20;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#424B52;stop-opacity:1" />
      </linearGradient>
    </defs>
  `;
  
  // Настройки графика
  const margin = { top: 20, right: 20, bottom: 40, left: 40 };
  const width = svg.clientWidth - margin.left - margin.right;
  const height = svg.clientHeight - margin.top - margin.bottom;
  
  // Создаем сетку
  const gridLines = svg.querySelectorAll('.chart-grid');
  gridLines.forEach(line => line.remove());
  
  // Горизонтальные линии сетки
  for (let i = 0; i <= 5; i++) {
    const y = margin.top + (height / 5) * i;
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('class', 'chart-grid chart-grid-horizontal');
    line.setAttribute('x1', margin.left);
    line.setAttribute('x2', width + margin.left);
    line.setAttribute('y1', y);
    line.setAttribute('y2', y);
    svg.appendChild(line);
  }
  
  // Вертикальные линии сетки
  for (let i = 0; i <= sortedDates.length - 1; i++) {
    const x = margin.left + (width / (sortedDates.length - 1)) * i;
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('class', 'chart-grid');
    line.setAttribute('x1', x);
    line.setAttribute('x2', x);
    line.setAttribute('y1', margin.top);
    line.setAttribute('y2', height + margin.top);
    svg.appendChild(line);
  }
  
  // Создаем точки и линии
  const points = [];
  let pathData = '';
  
  sortedDates.forEach((date, index) => {
    const visits = visitsByDate[date];
    const x = margin.left + (width / (sortedDates.length - 1)) * index;
    const y = margin.top + height - (visits / maxVisits) * height;
    
    points.push({ x, y, visits, date });
    
    if (index === 0) {
      pathData += `M ${x} ${y}`;
    } else {
      pathData += ` L ${x} ${y}`;
    }
  });
  
  // Создаем линию тренда (простая линейная регрессия)
  const trendLine = createTrendLine(points, margin, width, height);
  
  // Добавляем линию тренда
  const trendPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  trendPath.setAttribute('class', 'chart-trend');
  trendPath.setAttribute('d', trendLine);
  svg.appendChild(trendPath);
  
  // Добавляем основную линию
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('class', 'chart-line');
  path.setAttribute('d', pathData);
  path.setAttribute('stroke', 'url(#lineGradient)');
  svg.appendChild(path);
  
  // Добавляем точки с задержкой анимации
  points.forEach((point, index) => {
    setTimeout(() => {
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('class', 'chart-point');
      circle.setAttribute('cx', point.x);
      circle.setAttribute('cy', point.y);
      circle.setAttribute('r', 6);
      circle.setAttribute('data-index', index);
      svg.appendChild(circle);
      
      // Добавляем цифру возле точки
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('class', 'point-value');
      text.setAttribute('x', point.x);
      text.setAttribute('y', point.y - 15);
      text.textContent = point.visits;
      svg.appendChild(text);
      
      // Добавляем обработчики событий для точек
      addPointEvents(circle, point, index);
    }, 1000 + (index * 200)); // Задержка после анимации линии
  });
  
  // Создаем подписи дат
  chartLabels.innerHTML = '';
  sortedDates.forEach((date, index) => {
    const label = document.createElement('div');
    label.textContent = formatDate(date).split('.')[0] + '.' + formatDate(date).split('.')[1];
    label.style.flex = '1';
    label.style.textAlign = 'center';
    label.style.fontSize = '12px';
    label.style.color = '#718096';
    chartLabels.appendChild(label);
  });
  
  chartContainer.style.display = 'block';
}

// Функция создания линии тренда
function createTrendLine(points, margin, width, height) {
  if (points.length < 2) return '';
  
  // Простая линейная регрессия
  const n = points.length;
  const sumX = points.reduce((sum, p) => sum + p.x, 0);
  const sumY = points.reduce((sum, p) => sum + p.y, 0);
  const sumXY = points.reduce((sum, p) => sum + p.x * p.y, 0);
  const sumXX = points.reduce((sum, p) => sum + p.x * p.x, 0);
  
  const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;
  
  const startX = margin.left;
  const endX = margin.left + width;
  const startY = slope * startX + intercept;
  const endY = slope * endX + intercept;
  
  return `M ${startX} ${startY} L ${endX} ${endY}`;
}

// Функция добавления событий к точкам
function addPointEvents(circle, point, index) {
  let tooltip = null;
  
  function showTooltip() {
    if (tooltip) return;
    
    tooltip = document.createElement('div');
    tooltip.className = 'point-label show';
    tooltip.textContent = `${point.visits}`;
    document.body.appendChild(tooltip);
    
    const rect = circle.getBoundingClientRect();
    tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
    tooltip.style.top = `${rect.top - tooltip.offsetHeight - 10}px`;
    
    circle.classList.add('selected');
  }
  
  function hideTooltip() {
    if (tooltip) {
      document.body.removeChild(tooltip);
      tooltip = null;
    }
    circle.classList.remove('selected');
  }
  
  // Десктоп события
  circle.addEventListener('mouseenter', showTooltip);
  circle.addEventListener('mouseleave', hideTooltip);
  
  // Мобильные события
  circle.addEventListener('touchstart', (e) => {
    e.preventDefault();
    showTooltip();
    setTimeout(hideTooltip, 2000);
  });
  
  circle.addEventListener('click', (e) => {
    e.preventDefault();
    if (tooltip) {
      hideTooltip();
    } else {
      showTooltip();
    }
  });
}

async function showStats(){
  if (!datesValid()) { alert('Укажите корректный диапазон (не более 62 дней)'); return; }
  showLoader('Загрузка данных');
  try{
    const url = `${API}?act=stats&from=${fromEl.value}&to=${toEl.value}&territory=${encodeURIComponent(terrEl.value||'')}&rep=${encodeURIComponent(repEl.value||'')}`;
    const js = await (await fetch(url)).json();
    if (!js.ok) { alert(js.error||'Ошибка'); return; }

    // Анимация статистики
    const statsContainer = document.getElementById('stats');
    statsContainer.style.display = 'flex';
    
    // Анимируем счетчики
    const v1El = document.getElementById('v1');
    const v2El = document.getElementById('v2');
    const v3El = document.getElementById('v3');
    
    setTimeout(() => {
      animateCounter(v1El, js.stats.visits_total);
      animateCounter(v2El, js.stats.unique_visits);
      animateCounter(v3El, js.stats.lpus_total);
    }, 200);

    // Создаем график
    if (js.visits && js.visits.length > 0) {
      createChart(js.visits);
    }

    // Анимация таблицы с разделителями дат
    const tbody = document.querySelector('#table tbody');
    tbody.innerHTML = '';
    
    const table = document.getElementById('table');
    table.style.display = '';
    
    // Группируем визиты по датам
    const visitsByDate = {};
    js.visits.forEach(visit => {
      if (!visitsByDate[visit.date]) {
        visitsByDate[visit.date] = [];
      }
      visitsByDate[visit.date].push(visit);
    });
    
    // Сортируем даты
    const sortedDates = Object.keys(visitsByDate).sort();
    
    let rowIndex = 0;
    sortedDates.forEach((date, dateIndex) => {
      const visits = visitsByDate[date];
      
      // Добавляем разделитель даты
      setTimeout(() => {
        const separatorRow = document.createElement('tr');
        const separatorCell = document.createElement('td');
        separatorCell.colSpan = 4;
        separatorCell.className = 'date-separator';
        separatorCell.textContent = `${formatDate(date)} (${visits.length} визит${visits.length === 1 ? '' : visits.length < 5 ? 'а' : 'ов'})`;
        separatorRow.appendChild(separatorCell);
        tbody.appendChild(separatorRow);
      }, rowIndex * 50);
      rowIndex++;
      
      // Добавляем строки визитов для этой даты
      visits.forEach((visit, visitIndex) => {
        setTimeout(() => {
          const tr = document.createElement('tr');
          tr.className = 'table-row';
          tr.innerHTML = `
            <td data-label="Дата визита">${visit.date||''}</td>
            <td data-label="Имя доктора">${visit.doctor||''}</td>
            <td data-label="Специальность">${visit.specialty||''}</td>
            <td data-label="ЛПУ">${visit.lpu||''}</td>
          `;
      tbody.appendChild(tr);
        }, rowIndex * 50);
        rowIndex++;
    });
    });
    
  }catch(e){ alert('Ошибка запроса: '+e); }
  finally{ hideLoader(); }
}


// Слушатели
fromEl.addEventListener('change', loadTerritories);
toEl.addEventListener('change', loadTerritories);
terrEl.addEventListener('change', loadReps);
btn.addEventListener('click', showStats);

</script>
</body>
</html>
